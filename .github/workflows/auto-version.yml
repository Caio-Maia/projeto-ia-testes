name: Auto Version & Release

on:
  push:
    branches:
      - develop
    paths-ignore:
      - '**.md'
      - '.github/**'

jobs:
  version-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get commit messages since last tag
        id: commits
        run: |
          # Pega √∫ltima tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            # Se n√£o h√° tags, pega todos os commits
            COMMITS=$(git log --pretty=format:"%s" -20)
          else
            # Pega commits desde a √∫ltima tag
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s")
          fi
          
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Pega √∫ltimo commit para exibi√ß√£o
          LAST_COMMIT=$(git log -1 --pretty=%B)
          echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT

      - name: Determine version bump type
        id: bump
        run: |
          COMMITS="${{ steps.commits.outputs.commits }}"
          
          # Detecta tipo de bump baseado nas mensagens de commit
          # Prioridade: MAJOR > MINOR > PATCH
          
          if echo "$COMMITS" | grep -iE "(BREAKING CHANGE|breaking:|major:|^major\b)" > /dev/null; then
            echo "type=major" >> $GITHUB_OUTPUT
            echo "üöÄ Detected MAJOR version bump"
          elif echo "$COMMITS" | grep -iE "(^feat|feature:|minor:|^add\b)" > /dev/null; then
            echo "type=minor" >> $GITHUB_OUTPUT
            echo "‚ú® Detected MINOR version bump"
          else
            echo "type=patch" >> $GITHUB_OUTPUT
            echo "üîß Detected PATCH version bump"
          fi

      - name: Get current version
        id: current
        run: |
          CURRENT_VERSION=$(node -p "require('./front/package.json').version")
          echo "version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT_VERSION"

      - name: Calculate new version
        id: new
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          BUMP_TYPE="${{ steps.bump.outputs.type }}"
          
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          
          case $BUMP_TYPE in
            major)
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
              ;;
            patch)
              NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
              ;;
          esac
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Update package.json files
        run: |
          NEW_VERSION="${{ steps.new.outputs.version }}"
          
          cd front
          npm version $NEW_VERSION --no-git-tag-version
          cd ..
          
          cd backend
          npm version $NEW_VERSION --no-git-tag-version
          cd ..
          
          echo "‚úÖ Updated package.json files to v$NEW_VERSION"

      - name: Commit version bump to develop
        run: |
          NEW_VERSION="${{ steps.new.outputs.version }}"
          
          git add front/package.json front/package-lock.json backend/package.json backend/package-lock.json 2>/dev/null || true
          git add front/package.json backend/package.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "chore: bump version to v$NEW_VERSION [skip ci]"
            git push origin develop
          fi

      - name: Merge develop into main
        run: |
          git fetch origin main
          git checkout main
          git merge develop --no-ff -m "chore: release v${{ steps.new.outputs.version }} [skip ci]"
          git push origin main

      - name: Create and push tag on main
        run: |
          NEW_VERSION="${{ steps.new.outputs.version }}"
          TAG_NAME="v$NEW_VERSION"
          
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"
          
          echo "üè∑Ô∏è Created tag: $TAG_NAME"

      - name: Generate changelog
        id: changelog
        run: |
          COMMITS="${{ steps.commits.outputs.commits }}"
          
          # Organiza commits por tipo
          BREAKING=$(echo "$COMMITS" | grep -iE "(BREAKING CHANGE|breaking:|major:)" || true)
          FEATURES=$(echo "$COMMITS" | grep -iE "(^feat|feature:)" || true)
          FIXES=$(echo "$COMMITS" | grep -iE "(^fix|bugfix:|hotfix:)" || true)
          OTHER=$(echo "$COMMITS" | grep -ivE "(BREAKING|feat|feature|fix|bugfix|hotfix|chore:.*version)" || true)
          
          CHANGELOG=""
          
          if [ -n "$BREAKING" ]; then
            CHANGELOG="$CHANGELOG### ‚ö†Ô∏è Breaking Changes\n"
            while IFS= read -r line; do
              [ -n "$line" ] && CHANGELOG="$CHANGELOG- $line\n"
            done <<< "$BREAKING"
            CHANGELOG="$CHANGELOG\n"
          fi
          
          if [ -n "$FEATURES" ]; then
            CHANGELOG="$CHANGELOG### ‚ú® Features\n"
            while IFS= read -r line; do
              [ -n "$line" ] && CHANGELOG="$CHANGELOG- $line\n"
            done <<< "$FEATURES"
            CHANGELOG="$CHANGELOG\n"
          fi
          
          if [ -n "$FIXES" ]; then
            CHANGELOG="$CHANGELOG### üêõ Bug Fixes\n"
            while IFS= read -r line; do
              [ -n "$line" ] && CHANGELOG="$CHANGELOG- $line\n"
            done <<< "$FIXES"
            CHANGELOG="$CHANGELOG\n"
          fi
          
          if [ -n "$OTHER" ]; then
            CHANGELOG="$CHANGELOG### üìù Other Changes\n"
            while IFS= read -r line; do
              [ -n "$line" ] && CHANGELOG="$CHANGELOG- $line\n"
            done <<< "$OTHER"
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.new.outputs.version }}
          name: Release v${{ steps.new.outputs.version }}
          body: |
            ## üöÄ Release v${{ steps.new.outputs.version }}
            
            **Bump Type:** ${{ steps.bump.outputs.type }}
            **Previous Version:** ${{ steps.current.outputs.version }}
            
            ${{ steps.changelog.outputs.changelog }}
            
            ---
            *Automatically generated by GitHub Actions*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## üéâ Release Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Previous Version | ${{ steps.current.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| New Version | ${{ steps.new.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bump Type | ${{ steps.bump.outputs.type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | v${{ steps.new.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Branches Updated" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ develop (version bump)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ main (merged from develop)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Tag created on main" >> $GITHUB_STEP_SUMMARY
